<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">
	<changeSet id="UNIONVMS-4466-triggeredsubscription" author="nikospara">
		<createTable tableName="triggered_subscription">
			<column name="id" type="BIGINT">
				<constraints primaryKey="true" primaryKeyName="pk_triggered_subscription" />
			</column>
			<column name="source" type="VARCHAR(50)" />
			<column name="creation_date" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="subscription_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="triggered_subscription" baseColumnNames="subscription_id" referencedTableName="subscription" referencedColumnNames="id" constraintName="fk_triggered_subscription_subscription" />

		<createTable tableName="triggered_subscription_data">
			<column name="trig_subscription_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="key" type="VARCHAR(50)">
				<constraints nullable="false" />
			</column>
			<column name="value" type="VARCHAR(200)" />
		</createTable>

		<addPrimaryKey tableName="triggered_subscription_data" columnNames="trig_subscription_id,key" constraintName="pk_triggered_subscription_data" />
		<addForeignKeyConstraint baseTableName="triggered_subscription_data" baseColumnNames="trig_subscription_id" referencedTableName="triggered_subscription" referencedColumnNames="id" constraintName="fk_triggered_subscription_data" />
	</changeSet>

	<changeSet id="UNIONVMS-4466-triggeredsubscription-add-columns" author="gmanifavas">
		<addColumn tableName="triggered_subscription">
			<column name="trigger_message_id" type="VARCHAR(36)"/>
			<column name="active" type="BOOLEAN"/>
		</addColumn>
	</changeSet>

	<changeSet id="UNIONVMS-4579-triggeredsubscription-effective-from" author="nikospara">
		<addColumn tableName="triggered_subscription">
			<column name="effective_from" type="TIMESTAMP WITHOUT TIME ZONE" />
		</addColumn>
		<update tableName="triggered_subscription">
			<column name="effective_from" valueComputed="creation_date" />
		</update>
		<addNotNullConstraint tableName="triggered_subscription" columnName="effective_from" />

		<rollback>
			<dropColumn tableName="triggered_subscription" columnName="effective_from" />
		</rollback>
	</changeSet>
</databaseChangeLog>
