<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet author="emrinalgr (generated)" id="1513597247428-3">
        <createTable tableName="subscription">
            <column name="id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="channel" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="delay" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(255)"/>
            <column name="enabled" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="end_point" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="subscription_guid" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="message_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="organisation" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="state_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="subscription_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="trigger_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="accessibility" type="VARCHAR(255)" defaultValue="UNKNOWN">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="idx_subscription" tableName="subscription">
            <column name="name"/>
            <column name="description"/>
            <column name="channel"/>
            <column name="end_point"/>
            <column name="message_type"/>
            <column name="subscription_type"/>
            <column name="organisation"/>
            <column name="accessibility"/>
            <column name="end_date"/>
            <column name="start_date"/>
            <column name="enabled"/>
            <column name="state_type"/>
        </createIndex>
    </changeSet>

    <changeSet author="emrinalgr (generated)" id="1513597247428-6">
        <addPrimaryKey columnNames="id" constraintName="subscription_pkey" tableName="subscription"/>
    </changeSet>
    <changeSet author="emrinalgr (generated)" id="1513597247428-7">
        <addUniqueConstraint columnNames="subscription_guid" constraintName="uk_4olkrsd7yct4foeqt404bgr0f" tableName="subscription"/>
    </changeSet>
    <changeSet author="emrinalgr (generated)" id="1513597247428-8">
        <addUniqueConstraint columnNames="name" constraintName="uk_by8678y0av8o0t5xtgg1gak2w" tableName="subscription"/>
    </changeSet>

    <changeSet author="emrinalgr (generated)" id="1513597247428-10">
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="area" constraintName="fk_kslfqcm0wbsu2jj7c4x5jatks" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="subscription"/>
    </changeSet>
    <changeSet author="emrinalgr (generated)" id="1513597247428-11">
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="condition" constraintName="fk_om5bdiadsxse0i02kiyleyy7k" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="subscription"/>
    </changeSet>

    <changeSet id="UNIONVMS-4466-subscription" author="nikospara">
        <dropIndex tableName="subscription" indexName="idx_subscription" />
        <renameColumn tableName="subscription" oldColumnName="enabled" newColumnName="active" />
        <renameColumn tableName="subscription" oldColumnName="organisation" newColumnName="organisation_id" />
        <renameColumn tableName="subscription" oldColumnName="end_point" newColumnName="endpoint_id" />
        <renameColumn tableName="subscription" oldColumnName="channel" newColumnName="channel_id" />
        <update tableName="subscription">
            <column name="message_type" value="NONE" />
        </update>
        <update tableName="subscription">
            <column name="accessibility" value="PUBLIC" />
        </update>
        <dropDefaultValue tableName="subscription" columnName="accessibility" />
        <modifyDataType tableName="subscription" columnName="accessibility" newDataType="VARCHAR(10)" />
        <modifyDataType tableName="subscription" columnName="message_type" newDataType="VARCHAR(20)" />
        <addColumn tableName="subscription">
            <column name="alert" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="logbook" type="BOOLEAN" />
            <column name="consolidated" type="BOOLEAN" />
            <column name="vessel_ids" type="INT" />
            <column name="gen_new_report_id" type="BOOLEAN" />
            <column name="history" type="INT" />
            <column name="frequency" type="INT" />
            <column name="immediate" type="BOOLEAN" />
            <column name="time_expr" type="VARCHAR(20)" />
        </addColumn>

        <rollback>
            <renameColumn tableName="subscription" oldColumnName="active" newColumnName="enabled" />
            <renameColumn tableName="subscription" oldColumnName="organisation_id" newColumnName="organisation" />
            <renameColumn tableName="subscription" oldColumnName="endpoint_id" newColumnName="end_point" />
            <renameColumn tableName="subscription" oldColumnName="channel_id" newColumnName="channel" />
            <modifyDataType tableName="subscription" columnName="message_type" newDataType="VARCHAR(255)" />
            <update tableName="subscription">
                <column name="message_type" value="FLUX_FA_REPORT_MESSAGE" />
            </update>
            <modifyDataType tableName="subscription" columnName="accessibility" newDataType="VARCHAR(255)" />
            <addDefaultValue tableName="subscription" columnName="accessibility" defaultValue="UNKNOWN" />
            <update tableName="subscription">
                <column name="accessibility" value="UNKNOWN" />
            </update>
            <dropColumn tableName="subscription" columnName="alert" />
            <dropColumn tableName="subscription" columnName="logbook" />
            <dropColumn tableName="subscription" columnName="consolidated" />
            <dropColumn tableName="subscription" columnName="vessel_ids" />
            <dropColumn tableName="subscription" columnName="gen_new_report_id" />
            <dropColumn tableName="subscription" columnName="history" />
            <dropColumn tableName="subscription" columnName="frequency" />
            <dropColumn tableName="subscription" columnName="immediate" />
            <dropColumn tableName="subscription" columnName="time_expr" />
            <createIndex indexName="idx_subscription" tableName="subscription">
                <column name="name"/>
                <column name="description"/>
                <column name="channel"/>
                <column name="end_point"/>
                <column name="message_type"/>
                <column name="subscription_type"/>
                <column name="organisation"/>
                <column name="accessibility"/>
                <column name="end_date"/>
                <column name="start_date"/>
                <column name="enabled"/>
                <column name="state_type"/>
            </createIndex>
        </rollback>
    </changeSet>

    <changeSet id="UNIONVMS-4466-helper-tables" author="nikospara">
        <createTable tableName="subscription_emails">
            <column name="subscription_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="index" type="INT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="subscription_emails" baseColumnNames="subscription_id" constraintName="FK_SUBSCRIPTION_EMAILS_SUBSCRIPTION" referencedTableName="subscription" referencedColumnNames="id" />

        <createTable tableName="email_body">
            <column name="subscription_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_EMAIL_BODY"/>
            </column>
            <column name="body" type="CLOB">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="email_body" baseColumnNames="subscription_id" constraintName="FK_EMAIL_BODY_SUBSCRIPTION" referencedTableName="subscription" referencedColumnNames="id" />
    </changeSet>

    <changeSet id="UNIONVMS-4473-remove-notnull-constraints" author="gmanifavas">
        <dropNotNullConstraint tableName="subscription" columnName="alert" />
        <dropNotNullConstraint tableName="subscription" columnName="endpoint_id" />
        <dropNotNullConstraint tableName="subscription" columnName="channel_id" />
        <dropNotNullConstraint tableName="subscription" columnName="organisation_id" />
        <dropNotNullConstraint tableName="subscription" columnName="trigger_type" />
        <dropNotNullConstraint tableName="subscription" columnName="start_date" />
        <dropNotNullConstraint tableName="subscription" columnName="end_date" />
        <dropNotNullConstraint tableName="subscription" columnName="accessibility" />
        <dropNotNullConstraint tableName="subscription" columnName="subscription_guid" />
        <dropNotNullConstraint tableName="subscription" columnName="state_type" />
        <dropNotNullConstraint tableName="subscription" columnName="subscription_type" />
    </changeSet>

    <changeSet id="UNIONVMS-4466-subscription-email-configuration" author="gmanifavas">
        <addColumn tableName="subscription">
            <column name="history_unit" type="VARCHAR(10)"/>
            <column name="has_email" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_pdf" type="BOOLEAN"/>
            <column name="has_attachments" type="BOOLEAN"/>
            <column name="password" type="VARCHAR(32)"/>
            <column name="is_xml" type="BOOLEAN"/>
        </addColumn>
    </changeSet>

    <changeSet id="UNIONVMS-4466-add-frequency-unit" author="gmanifavas">
        <addColumn tableName="subscription">
            <column name="frequency_unit" type="VARCHAR(10)"/>
        </addColumn>
    </changeSet>

    <changeSet id="UNIONVMS-4466-subscription-dead-code" author="nikospara">
        <dropColumn tableName="subscription" columnName="subscription_type" />
        <dropUniqueConstraint tableName="subscription" constraintName="uk_4olkrsd7yct4foeqt404bgr0f" />
        <dropColumn tableName="subscription" columnName="subscription_guid" />
        <dropColumn tableName="subscription" columnName="accessibility" />
        <dropColumn tableName="subscription" columnName="delay" />
        <dropColumn tableName="subscription" columnName="state_type" />
        <dropTable tableName="condition" />

        <rollback>
            <createTable tableName="condition">
                <column name="id" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="composite_type" type="VARCHAR(255)"/>
                <column name="condition" type="VARCHAR(255)"/>
                <column name="condition_type" type="VARCHAR(255)">
                    <constraints nullable="false"/>
                </column>
                <column name="criteria_type" type="VARCHAR(255)"/>
                <column name="message_type" type="VARCHAR(255)"/>
                <column name="end_operator" type="VARCHAR(255)"/>
                <column name="position" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="start_operator" type="VARCHAR(255)"/>
                <column name="sub_criteria_type" type="VARCHAR(255)"/>
                <column name="value" type="VARCHAR(255)"/>
                <column name="value_type" type="VARCHAR(255)"/>
                <column name="subscription_id" type="BIGINT"/>
            </createTable>
            <addPrimaryKey columnNames="id" constraintName="condition_pkey" tableName="condition"/>
            <createIndex indexName="condition_i_1" tableName="condition">
                <column name="subscription_id" type="bigint"/>
            </createIndex>
            <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="condition" constraintName="fk_om5bdiadsxse0i02kiyleyy7k" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="subscription"/>
            <addColumn tableName="subscription">
                <column name="subscription_type" type="VARCHAR(255)" defaultValue="TX_PULL">
                    <constraints nullable="false"/>
                </column>
                <column name="subscription_guid" type="VARCHAR(36)" />
                <column name="accessibility" type="VARCHAR(255)" defaultValue="UNKNOWN">
                    <constraints nullable="false"/>
                </column>
                <column name="delay" type="VARCHAR(255)"/>
                <column name="state_type" type="VARCHAR(255)" defaultValue="INACTIVE">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
            <sql dbms="postgresql">
                <comment>The GUID is not used anyway, so a random value is good enough</comment>
                UPDATE Subscription SET subscription_guid=concat(uuid_generate_v4(),'');
            </sql>
            <addUniqueConstraint columnNames="subscription_guid" constraintName="uk_4olkrsd7yct4foeqt404bgr0f" tableName="subscription"/>
            <dropDefaultValue tableName="subscription" columnName="subscription_type" />
            <dropDefaultValue tableName="subscription" columnName="state_type" />
        </rollback>
    </changeSet>

    <changeSet id="UNIONVMS-4579-stop-conditions" author="nikospara">
        <addColumn tableName="subscription">
            <column name="has_areas" type="BOOLEAN" valueComputed="((SELECT count(*) FROM area WHERE subscription_id=subscription.id)>0)" />
            <column name="has_assets" type="BOOLEAN" valueComputed="((SELECT count(*) FROM asset WHERE subscription_id=subscription.id)>0 OR (SELECT count(*) FROM asset_group WHERE subscription_id=subscription.id)>0)" />
            <column name="has_start_activities" type="BOOLEAN" />
            <column name="deadline" type="INT" />
            <column name="deadline_unit" type="VARCHAR(10)" />
            <column name="stop_when_quit_area" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <createTable tableName="start_activities">
            <column name="subscription_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(16)" >
                <constraints nullable="false"/>
            </column>
            <column name="value" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="subscription_id,type,value" constraintName="pk_start_activities" tableName="start_activities"/>
        <addForeignKeyConstraint baseTableName="start_activities" baseColumnNames="subscription_id" constraintName="FK_START_ACTIVITIES_SUBSCRIPTION" referencedTableName="subscription" referencedColumnNames="id" />

        <createIndex tableName="start_activities" indexName="idx_start_activities_subscription">
            <column name="subscription_id" />
        </createIndex>

        <createTable tableName="stop_activities">
            <column name="subscription_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(16)" >
                <constraints nullable="false"/>
            </column>
            <column name="value" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="subscription_id,type,value" constraintName="pk_stop_activities" tableName="stop_activities"/>
        <addForeignKeyConstraint baseTableName="stop_activities" baseColumnNames="subscription_id" constraintName="FK_STOP_ACTIVITIES_SUBSCRIPTION" referencedTableName="subscription" referencedColumnNames="id" />

        <createIndex tableName="stop_activities" indexName="idx_stop_activities_subscription">
            <column name="subscription_id" />
        </createIndex>
    </changeSet>
</databaseChangeLog>
